import AR.AR as AR
import AR.schoology as schoology
import asyncio
import csv
import sys

clashing_ids = [ '92825', '92233', '89113', '92658', '88620', '85565', '88840',
'91023', '88615', '92675', '88314', '91076', '91421', '92709', '86045', '86190',
'86479', '90965', '89429', '89723', '85192', '91851', '85258', '91707', '87527',
'92982', '88892', '89252', '90266', '91406', '93223', '93519', '90061', '85384',
'93339', '91113', '91829', '90219', '91982', '89092', '86109', '81411', '90674',
'91492', '90157', '85291', '87136', '85347', '87867', '90085', '92213', '82809',
'88275', '89168', '90653', '88658', '91012', '91424', '90647', '89519', '86276',
'83296', '89410', '88400', '89658', '85460', '91568', '85329', '90828', '86225',
'90400', '83624', '90871', '87660', '85416', '85355', '83734', '87762', '90261',
'92205', '92171', '86322', '81417', '93478', '88891', '92170', '91130', '85438',
'92091', '87649', '85871', '87918', '87963', '89812', '89559', '86951', '83765',
'91652', '89008', '90675', '82780', '89032', '92197', '92615', '89317', '91017',
'90537', '92229', '86511', '88467', '85541', '87326', '87937', '90384', '88821',
'87480', '85893', '89510', '87256', '94171', '89214', '88817', '89586', '87519',
'91818', '92032', '89580', '91082', '88150', '90962', '92317', '88407', '85996',
'93278', '86719', '91026', '87639', '92624', '93090', '92087', '90903', '88329',
'90966', '90371', '87992', '85365', '89878', '89097', '83038', '83077', '89331',
'89804', '91936', '90511', '87547', '89251', '86985', '94172', '87890', '83620',
'93474', '91970', '86258', '92384', '87654', '92759', '88454', '86166', '92621',
'88921', '82819', '85520', '92642', '88359', '92800', '92619', '90079', '88368',
'90601', '83310', '86737', '92684', '91186', '87986', '83798', '93145', '93265',
'86431', '89427', '88152', '88119', '93374', '87453', '88258', '90194', '88848',
'93875', '89571', '88709', '86356', '92122', '83667', '88099', '90473', '92865',
'88825', '92340', '87070', '92415', '90162', '92053', '82943', '92095', '87541',
'90125', '90922', '91845', '90113', '88459', '89592', '88997', '87936', '93191',
'87102', '86341', '87467', '91309', '83984', '90370', '92647', '92960', '87535',
'90984', '93987', '92869', '86189', '88556', '89110', '92392', '90483', '92187',
'88623', '90878', '86864', '89107', '88417', '91812', '92294', '89594', '85701',
'86120', '88438', '90592', '87930', '90320', '86999', '88847', '93096', '89198',
'94176', '84196', '89934', '91215', '90253', '89747', '91365', '93715', '87027',
'88456', '91383', '93184', '87636', '91097', '89776', '83051', '89306', '85589',
'87432', '86718', '86895', '90223', '90784', '90365', '90238', '93272', '91198',
'91867', '85627', '88455', '91502', '90779', '91187', '89233', '92650', '87858',
'92802', '90804', '82871', '93197', '90094', '90783', '83249', '87534', '83289',
'92669', '87577', '90832', '85620', '87028', '88697', '84026', '86884', '91137',
'83606', '92328', '83783', '90770', '93405', '90414', '86935', '85410', '89943',
'92632', '90046', '88319', '94185', '89031', '90315', '86157', '92000', '89053',
'87966', '93279', '82875', '85348', '90829', '86926', '91203', '92535', '91064',
'90333', '92144', '84249', '90654', '89623', '91402', '90927', '91429', '92665',
'87170', '85085', '89497', '87634', '89847', '88650', '91461', '92640', '89292',
'89462', '91918', '94174', '92034', '91981', '87265', '92625', '85168', '87699',
'92691', '89853', '91832', '86342', '90583', '85531', '86933', '86205', '87110',
'92318', '87520', '88710', '90361', '82983', '89633', '91624', '90134', '90794',
'92520', '88688', '93366', '90310', '87199', '90201', '88253', '87974', '87913',
'91092', '83953', '86231', '90432', '90863', '89128', '85714', '87088', '85354',
'87912', '90796', '92230', '86046', '92696', '89685', '92992', '92749', '88890',
'90071', '90106', '85208', '90204', '91473', '83727', '83756', '94188', '92162',
'82316', '90158', '87113', '88324', '89263', '94180', '83836', '93083', '88731',
'92143', '88260', '88326', '89503', '85307', '89211', '91635', '92353', '90485',
'87244', '87481', '85020', '92929', '92106', '90970', '91718', '87825', '85539',
'90252', '86312', '85176', '86309', '90156', '89971', '91006', '83193', '90139',
'91126', '89205', '94116', '88334', '91784', '91828', '94182', '89684', '91257',
'82905', '89407', '88124', '91567', '87744', '88021', '85468', '92241', '90540',
'93259', '93520', '91491', '90613', '92692', '82923', '82907', '87350', '87233',
'89733', '90102', '90621', '89197', '91978', '87972', '87666', '91287', '89208',
'92196', '93497', '91305', '84164', '87619', '87989', '92710', '89662', '83717',
'86787', '86722', '89591', '88780', '90350', '89054', '84039', '87667', '94175',
'90120', '86371', '90636', '93089', '87739', '94179', '92111', '85366', '92660',
'88014', '86221', '86261', '92352', '90536', '94173', '88349', '92232', '90111',
'82895', '87489', '86941', '92679', '87879', '93124', '87452', '92237', '83821',
'91468', '87426', '90672', '91090', '90164', '87239', '93713', '92272', '92104',
'89451', '91864', '91361', '93500', '88605', '90180', '88488', '89805', '91803',
'93018', '90045', '86902', '87587', '92228', '91825', '88716', '87725', '90351',
'89489', '90679', '89648', '86139', '88168', '91992', '89449', '88419', '86219',
'92543', '86847', '87524', '89020', '88932', '90658', '86218', '88657', '90130',
'93185', '87051', '91559', '90513', '83436', '90848', '83963', '91877', '87583',
'90982', '85393', '93375', '85233', '92246', '93008', '90505', '88861', '89035',
'87581', '92953', '89423', '94025', '89247', '83845', '81090', '85390', '89765',
'83751', '91472', '88490', '88695', '90688', '93095', '84048', '89002', '90571',
'82865', '92828', '85217', '90423', '91578', '87139', '90160', '93068', '92195',
'86877', '91150', '91843', '91844', '92056', '88136', '90431', '91908', '91841',
'89965', '93367', '88846', '87516', '90980', '90246', '89059', '91501', '91579',
'87743', '87349', '88673', '92063', '86747', '88525', '87553', '91868', '88729',
'85358', '83856', '89906', '88866', '90226', '92859', '88743', '90119', '90685',
'85624', '93239', '87460', '88685', '91712', '86016', '92525', '92014', '91066',
'86838', '91460', '88330', '92622', '90390', '89033', '87818', '83837', '89169',
'91048', '91577', '86852', '91595', '87580', '91357', '84256', '83801', '91986',
'93266', '83883', '88290', '89663', '86727', '82864', '92198', '88114', '87089',
'86973', '89009', '87185', '82947', '87546', '91173', '92917', '87311', '90586',
'91027', '91500', '88507', '84058', '92057', '86829', '86955', '87048', '89336',
'91651', '89271', '85432', '88588', '87893', '91763', '88120', '92635', '85243',
'83672', '89910', '91401', '88993', '89532', '94184', '88481', '90854', '89585',
'91009', '90680', '94181', '83886', '92706', '83013', '91128', '85484', '91859',
'92866', '86861', '86731', '91786', '88616', '89231', '89350', '90612', '87921',
'87964', '91049', '87325', '91947', '91799', '91028', '82284', '90393', '90694',
'90969', '90123', '91899', '87648', '87692', '82896', '91148', '90602', '94183',
'88372', '92043', '92950', '87226', '90985', '89326', '91430', '86881', '87569',
'83697', '88870', '90405', '89558', '86155', '90563', '93426', '89666', '85412',
'90375', '91949', '87590', '89224', '92217', '90827', '87785', '86181', '88322',
'90721', '83831', '82836', '91865', '86896', '91420', '89479', '90050', '92693',
'89861', '88442', '91846', '86798', '87544', '91840', '87305', '90362', '83747',
'82962', '83750', '90099', '90851', '92956', '91436', '83805', '90873', '86119',
'89095', '86734', '87754', '88677', '86775', '93100', '91971', '88125', '88990',
'88416', '86802', '92670', '91861', '90213', '91759', '90967', '89799', '85555',
'90901', '89657', '91863', '87019', '90416', '86421', '90673', '90745', '89611',
'89142', '84078', '91564', '85063', '90826', '88816', '83858', '91723', '81396',
'88304', '94143', '87576']


async def delete_clashing_emails(environment, genesis_ids):
      """
      Looks up who has a clashing email, changes it to a unique, dummy email
      """
      async with schoology.Session(environment) as Schoology:
            async with Schoology.Users as Users:
                  results = await Users.csvexport(['mail', 'school_uid'])
                  schoology_emails = {}
                  for row in csv.reader(results.splitlines()[1:]):
                        schoology_emails[str(row[0])] = str(row[1])
                  for genesis_id in genesis_ids:
                        student = AR.student_by_id(genesis_id)
                        email = student.email
                        if email == None or email not in schoology_emails:
                              print(email)
                              print(f"Unable to determine email for {student}")
                              continue
                        clashing_student = AR.student_by_id(schoology_emails[student.email])
                        print(f"{genesis_id} needs the email address {student.email} but "
                              f"{clashing_student.student_id} currently has it.")
                        #await Users.add_update(
                        #      school_uid=clashing_student.student_id,
                        #      name_first=clashing_student.first_name,
                        #      name_last=clashing_student.last_name,
                        #      email=clashing_student.student_id + "@monroe.k12.nj.us",
                        #      role='Student',
                        #)

loop = asyncio.get_event_loop()
AR.init('../databases/2019-08-22-genesis.db')
loop.run_until_complete(delete_clashing_emails('production', clashing_ids))
loop.close()
